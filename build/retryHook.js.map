{"version":3,"sources":["../source/retryHook.js"],"names":[],"mappings":"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","file":"retryHook.js","sourcesContent":["\"use strict\";\n\nimport {Runnable} from \"mocha\";\n\nexport default class RetryHook extends Runnable {\n\n\tconstructor(times, title, fn) {\n\t\tsuper(title, fn);\n\t\tthis.times = times || 1;\n\t}\n\n\terror(error = this._error) {\n\t\tthis._error = null;\n\t\treturn error;\n\t}\n\n\trun(fn) {\n\t\tlet finished;\n\t\tlet emitted;\n\t\tlet runTimes = 1;\n\t\tconst multiple = (err) => {\n\t\t\tif (emitted) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\temitted = true;\n\t\t\tthis.emit(\"error\", err || new Error(\"done() called multiple times\"));\n\t\t};\n\t\tconst done = (err) => {\n\t\t\tlet start;\n\t\t\tif (this.timedOut) {\n\t\t\t\t// do nothing\n\t\t\t} else if (finished) {\n\t\t\t\tmultiple(err);\n\t\t\t} else if (err && runTimes !== this.times) {\n\t\t\t\trunTimes++;\n\t\t\t\tstart = new Date;\n\t\t\t\tthis._run(done);\n\t\t\t} else {\n\t\t\t\tthis.clearTimeout();\n\t\t\t\tthis.duration = new Date - start;\n\t\t\t\tfinished = true;\n\t\t\t\tfn(err);\n\t\t\t}\n\t\t};\n\t\tthis._run(done);\n\t}\n\n\t_run(done) {\n\t\tthis.timeout();\n\t\tconst ctx = this.ctx;\n\t\tif (ctx && ctx.runnable) {\n\t\t\tctx.runnable(this);\n\t\t}\n\t\tthis.callback = done;\n\t\tif (this.async) {\n\t\t\tthis.resetTimeout();\n\t\t\ttry {\n\t\t\t\tthis.fn.call(ctx, (error) => {\n\t\t\t\t\tif (error instanceof Error) {\n\t\t\t\t\t\tdone(error);\n\t\t\t\t\t} else if (error) {\n\t\t\t\t\t\tdone(new Error(\"done() invoked with non-Error: \" + error));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdone();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tdone(error);\n\t\t\t}\n\t\t} else if (this.asyncOnly) {\n\t\t\tdone(new Error(\"--async-only option in use without declaring `done()`\"));\n\t\t} else {\n\t\t\tconst callFn = () => {\n\t\t\t\tconst result = this.fn.call(ctx);\n\t\t\t\tif (result && typeof result.then === \"function\") {\n\t\t\t\t\tthis.resetTimeout();\n\t\t\t\t\tresult.then(() => done(), done);\n\t\t\t\t} else {\n\t\t\t\t\tdone();\n\t\t\t\t}\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tif (this.pending) {\n\t\t\t\t\tdone();\n\t\t\t\t} else {\n\t\t\t\t\tcallFn();\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tdone(error);\n\t\t\t}\n\t\t}\n\t}\n}\n"]}