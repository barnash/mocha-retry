{"version":3,"sources":["../source/retryHook.js"],"names":[],"mappings":"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","file":"retryHook.js","sourcesContent":["\"use strict\";\n\n\nvar RetryHook, Runnable;\n\nRetryHook = function(times, title, fn) {\n\tRunnable.call(this, title, fn);\n\tthis.times = times || 1;\n\treturn this.type = \"hook\";\n};\n\nRetryHook.prototype.error = function(err) {\n\tif (arguments.length === 0) {\n\t\terr = this._error;\n\t\tthis._error = null;\n\t\treturn err;\n\t}\n\treturn this._error = err;\n};\n\nRetryHook.prototype.run = function(fn) {\n\tvar done, emitted, finished, multiple, runTimes, start;\n\tfinished = emitted = void 0;\n\trunTimes = 1;\n\tmultiple = (function(_this) {\n\t\treturn function(err) {\n\t\t\tif (emitted) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\temitted = true;\n\t\t\treturn _this.emit(\"error\", err || new Error(\"done() called multiple times\"));\n\t\t};\n\t})(this);\n\tdone = (function(_this) {\n\t\treturn function(err) {\n\t\t\tvar start;\n\t\t\tif (_this.timedOut) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (finished) {\n\t\t\t\treturn multiple(err);\n\t\t\t}\n\t\t\tif ((err != null) && runTimes !== _this.times) {\n\t\t\t\trunTimes++;\n\t\t\t\tstart = new Date;\n\t\t\t\treturn _this._run(fn, done);\n\t\t\t}\n\t\t\t_this.clearTimeout();\n\t\t\t_this.duration = new Date - start;\n\t\t\tfinished = true;\n\t\t\treturn fn(err);\n\t\t};\n\t})(this);\n\tstart = new Date;\n\treturn this._run(fn, done);\n};\n\nRetryHook.prototype._run = function(fn, done) {\n\tvar callFn, ctx, err, error, error1, ms;\n\tms = this.timeout();\n\tctx = this.ctx;\n\tif (ctx) {\n\t\tctx.runnable(this);\n\t}\n\tthis.callback = done;\n\tif (this.async) {\n\t\tthis.resetTimeout();\n\t\ttry {\n\t\t\tthis.fn.call(ctx, function(err) {\n\t\t\t\tif (err instanceof Error || toString.call(err) === \"[object Error]\") {\n\t\t\t\t\treturn done(err);\n\t\t\t\t}\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn done(new Error(\"done() invoked with non-Error: \" + err));\n\t\t\t\t}\n\t\t\t\treturn done();\n\t\t\t});\n\t\t} catch (error) {\n\t\t\terr = error;\n\t\t\tdone(err);\n\t\t}\n\t\treturn;\n\t}\n\tif (this.asyncOnly) {\n\t\treturn done(new Error(\"--async-only option in use without declaring `done()`\"));\n\t}\n\tcallFn = (function(_this) {\n\t\treturn function(fn) {\n\t\t\tvar result;\n\t\t\tresult = fn.call(ctx);\n\t\t\tif (result && typeof result.then === \"function\") {\n\t\t\t\t_this.resetTimeout();\n\t\t\t\treturn result.then((function() {\n\t\t\t\t\treturn done();\n\t\t\t\t}), done);\n\t\t\t} else {\n\t\t\t\treturn done();\n\t\t\t}\n\t\t};\n\t})(this);\n\ttry {\n\t\tif (this.pending) {\n\t\t\treturn done();\n\t\t} else {\n\t\t\treturn callFn(this.fn);\n\t\t}\n\t} catch (error1) {\n\t\terr = error1;\n\t\treturn done(err);\n\t}\n};\n\nRunnable = require(\"mocha\").Runnable;\n\nRetryHook.prototype.__proto__ = Runnable.prototype;\n\nexport default RetryHook;\n\n\n"]}